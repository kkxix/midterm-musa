# Load Packages
library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)
library(dplyr)
library(knitr)
library(ggplot2)
library(stringr)
library(units)

#PHASE 1: DATA PREPARATION

# Property / Sales Data
property_sales <- st_read("https://github.com/MUSA-5080-Fall-2025/MUSA-5080-Fall-2025/releases/download/v1.0.0/opa_properties_public.csv")

#Anything in property_sales$zoning starting with R or IRMX. 
property_sales_res <- property_sales %>% 
  filter(str_detect(zoning, "^R") | str_detect(zoning, "IRMX")) %>%
  filter(str_detect(category_code_description, "SINGLE FAMILY") | 
           str_detect(category_code_description, "MULTI FAMILY") |
           str_detect(category_code_description, "MIXED USE")) %>%
  mutate(sale_price_n = as.numeric(sale_price)) %>% 
  filter(sale_price_n < 10000000) %>% 
  filter(sale_date >= as.Date("2023-01-01") & sale_date <= as.Date("2024-12-31") )

property_sales_res <- property_sales_res %>%
  filter(sale_price_n<10000000 & sale_price_n > 5000)

ggplot(property_sales_res, aes(x = sale_date, y = sale_price_n)) +
  geom_point()

ggplot(property_sales_res, aes(x = number_of_bedrooms, y = sale_price_n)) +
  geom_point()

#Converting blank cells to NA
colSums(property_sales_res == "")

property_sales_res <- as.data.frame(lapply(property_sales_res, function(x) {
  x <- trimws(x)  # remove leading/trailing spaces
  x[x == ""] <- NA
  return(x)
}))

colSums(is.na(property_sales_res))

# Load Census Data
philadelphia <- get_acs(
  geography = "tract",
  county = "Philadelphia",
  state = "PA",
  variables = c(median_h_income = "B19013_001", total_population = "B01003_001"),
  survey = "acs5",
  year = 2023,
  output = "wide",
  geometry = TRUE
)

# Load Spatial Amenities Data
park_properties <- st_read("https://hub.arcgis.com/api/v3/datasets/d52445160ab14380a673e5849203eb64_0/downloads/data?format=geojson&spatialRefId=4326&where=1%3D1")
hospitals <- st_read("https://opendata.arcgis.com/datasets/df8dc18412494e5abbb021e2f33057b2_0.geojson")
farmers_markets <- st_read("https://hub.arcgis.com/api/v3/datasets/0707c1f31e2446e881d680b0a5ee54bc_0/downloads/data?format=geojson&spatialRefId=4326&where=1%3D1")
schools <- st_read("https://hub.arcgis.com/api/v3/datasets/d46a7e59e2c246c891fbee778759717e_0/downloads/data?format=geojson&spatialRefId=4326&where=1%3D1")
landmarks <- st_read("https://hub.arcgis.com/api/v3/datasets/68628278b86244469d110232f81ea8f9_0/downloads/data?format=geojson&spatialRefId=4326&where=1%3D1")
bike_network <- st_read("https://hub.arcgis.com/api/v3/datasets/b5f660b9f0f44ced915995b6d49f6385_0/downloads/data?format=geojson&spatialRefId=4326&where=1%3D1")

# Transform property sales data to sf object
st_crs(property_sales_res)
property_sales_res$geometry <- st_as_sfc(property_sales_res$shape)
res_properties_sf <- st_sf(property_sales_res)

# Transform CRS for Spatial Amenities - to match that of the property sales data
park_properties <- st_transform(park_properties, st_crs(res_properties_sf))
hospitals <- st_transform(hospitals, st_crs(res_properties_sf))
farmers_markets <- st_transform(farmers_markets, st_crs(res_properties_sf))
schools <- st_transform(schools, st_crs(res_properties_sf))
landmarks <- st_transform(landmarks, st_crs(res_properties_sf))
bike_network <- st_transform(bike_network, st_crs(res_properties_sf))

# Transform census data CRS - to match that of the property sales data
st_crs(philadelphia)
philadelphia <- st_transform(philadelphia, st_crs(res_properties_sf))

# Join census data to property sales data
philadelphia <- philadelphia %>%
  mutate(
    census_tract = as.numeric(str_extract(NAME, "(?<=Census Tract )\\d+(\\.\\d+)?"))
  )

res_properties_sf <- st_join(res_properties_sf, philadelphia %>% select(median_h_incomeE, total_populationE), left = TRUE)

# Join Spatial Amenities Data

# 1. Join parks data - What is the distance to the nearest park?
# Note that some of the parks are super tiny! It also includes playgrounds and rec centers, etc

# Calculate distance matrix (properties to parks)
dist_matrix_parks <- st_distance(res_properties_sf, park_properties)

# Function to get mean distance to k nearest neighbors
park_distance <- function(dist_matrix_parks, k) {
  apply(dist_matrix_parks, 1, function(distances) {
    # Sort and take first k, then average
    mean(as.numeric(sort(distances)[1:k]))
  })
}

# Add nearest park distance as a column
res_properties_sf <- res_properties_sf %>%
  mutate(
    nearest_park = park_distance(dist_matrix_parks, k = 1))

#2 Join hospitals data - What is the distance to the nearest hospital?

# Calculate distance matrix (properties to hospitals)
dist_matrix_hospitals <- st_distance(res_properties_sf, hospitals)

# Function to get mean distance to k nearest neighbors
hosp_distance <- function(dist_matrix_hospitals, k) {
  apply(dist_matrix_hospitals, 1, function(distances) {
    # Sort and take first k, then average
    mean(as.numeric(sort(distances)[1:k]))
  })
}

# Add nearest hospital distance as a column
res_properties_sf <- res_properties_sf %>%
  mutate(
    nearest_hospital = hosp_distance(dist_matrix_hospitals, k = 1))

#hospital distance in miles
res_properties_sf <- res_properties_sf %>%
  mutate(
    nearest_hospital_mi = nearest_hospital/5280
  )

#3 Join farmers market data - what is the distance to the nearest farmers market?

# Calculate distance matrix (properties to farmers markets)
dist_matrix_market <- st_distance(res_properties_sf, farmers_markets)

# Function to get nearest distance
market_distance <- function(dist_matrix_market, k) {
  apply(dist_matrix_market, 1, function(distances) {
    # Sort and take first k, then average
    mean(as.numeric(sort(distances)[1:k]))
  })
}

# Add nearest farmer's market distance as a column
res_properties_sf <- res_properties_sf %>%
  mutate(
    nearest_fmarket = market_distance(dist_matrix_market, k = 1))

# market distance in miles
res_properties_sf <- res_properties_sf %>%
  mutate(
    nearest_fmarket_mi = nearest_fmarket/5280
  )

#PHASE 2: EXPLORATORY DATA ANALYSIS - DATA VISUALIZATIONS

#1 Geographic Distribution (Map)

res_properties_sf <- res_properties_sf %>%
  mutate(sale_price_n = as.numeric(sale_price_n))

# Map of Sale Prices
ggplot(res_properties_sf) +
  geom_sf(aes(color = sale_price_n), size = 1, alpha = 0.7) +
  scale_color_viridis_c(option = "plasma", labels = scales::dollar) +
  labs(
    title = "Distribution of Home Prices in Philadelphia",
    color = "Home Price"
  ) +
  theme_minimal()

# Map of Sale Prices - Log Transformed
ggplot() +
  geom_sf(data = philadelphia, fill = "gray95", color = "white") +
  geom_sf(data = res_properties_sf, aes(color = log10(sale_price_n)), size = 1.5, alpha = 0.7) +
  scale_color_viridis_c(
    option = "plasma",
    labels = function(x) dollar(10^x),
    name = "Sale Price (log scale)"
  ) +
  labs(
    title = "Residential Property Sale Prices in Philadelphia",
    subtitle = "Log-scaled price visualization",
    caption = "Data: Property Sales from 2023, 2024"
  ) +
  theme_minimal()

#2 Distribution of Sale Prices (Histogram)

ggplot(res_properties_sf, aes(x = sale_price_n)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "white", alpha = 0.8) +
  scale_x_continuous(labels = scales::dollar) +
  labs(
    title = "Distribution of Residential Sale Prices in Philadelphia",
    subtitle = "Data from 2023, 2024",
    x = "Sale Price (USD)",
    y = "Number of Properties"
  ) +
  theme_minimal()

# Sale Prices Histogram - Log Transformed
ggplot(res_properties_sf, aes(x = sale_price_n)) +
  geom_histogram(bins = 40, fill = "darkorange", color = "white", alpha = 0.8) +
  scale_x_log10(labels = dollar) +
  labs(
    title = "Residential Sale Prices in Philadelphia (Log Scale)",
    subtitle = "Data from 2023, 2024",
    x = "Sale Price (log10 USD)",
    y = "Number of Properties"
  ) +
  theme_minimal()

#3 Price vs. Structural Features - Scatter Plot
# Price vs. Number of Bedrooms
res_properties_sf <- res_properties_sf %>%
  mutate(number_of_bedrooms = as.numeric(number_of_bedrooms))

ggplot(
  data = res_properties_sf %>% filter(!is.na(number_of_bedrooms)),
  aes(x = number_of_bedrooms, y = sale_price_n)
) +
  geom_point(color = "steelblue", alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", color = "darkorange", se = TRUE) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Residential Sale Prices by Number of Bedrooms",
    subtitle = "Data from 2023, 2024 Philadelphia",
    x = "Number of Bedrooms",
    y = "Sale Price (USD)"
  ) +
  theme_minimal()

# 4 Price vs. Spatial Features - Scatter Plot
# Price vs. Distance to Nearest Farmer's Market

ggplot(
  data = res_properties_sf,
  aes(x = nearest_fmarket_mi, y = sale_price_n)
) +
  geom_point(color = "steelblue", alpha = 0.6, size = 2) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Residential Sale Prices by Nearest Market",
    subtitle = "Data from 2023, 2024 Philadelphia",
    x = "Distance to Nearest Farmer's Market, Miles",
    y = "Sale Price (USD)"
  ) +
  theme_minimal()

# 5 Creative Visualization